(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{414:function(_,t,v){"use strict";v.r(t);var e=v(17),a=Object(e.a)({},(function(){var _=this,t=_.$createElement,v=_._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"sophon-messager-设计说明书"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#sophon-messager-设计说明书"}},[_._v("#")]),_._v(" Sophon Messager 设计说明书")]),_._v(" "),v("p",[_._v("sophon-messager是一个用于管理本地消息的组件，用于保存地址消息、管理消息状态和控制推送消息的频率。")]),_._v(" "),v("ul",[v("li",[_._v("支持多个miner：提供了较为实用的API给miner推送消息")]),_._v(" "),v("li",[_._v("持久化存储：支持MySQL和SQLite两种存储方案")]),_._v(" "),v("li",[_._v("nonce管理：合理的分配nonce，降低nonce冲突")]),_._v(" "),v("li",[_._v("动态的控制推送频率和消息量")]),_._v(" "),v("li",[_._v("集成权限验证、trace及API限流")]),_._v(" "),v("li",[_._v("提供较为完善的命令行工具")])]),_._v(" "),v("h2",{attrs:{id:"详细设计"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#详细设计"}},[_._v("#")]),_._v(" 详细设计")]),_._v(" "),v("h3",{attrs:{id:"整体架构"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#整体架构"}},[_._v("#")]),_._v(" 整体架构")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://github.com/ipfs-force-community/sophon-docs/assets/1591330/c4de6a0b-2c33-4fee-8eff-0bc92614c42b",alt:""}})]),_._v(" "),v("h3",{attrs:{id:"功能模块"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#功能模块"}},[_._v("#")]),_._v(" 功能模块")]),_._v(" "),v("h4",{attrs:{id:"权限验证"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#权限验证"}},[_._v("#")]),_._v(" 权限验证")]),_._v(" "),v("p",[_._v("该验证分两部分，一是对访问sophon-messager 使用token是否合法的验证，二是验证是否具有访问API的权限，下图是权限验证流程图。")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://github.com/ipfs-force-community/sophon-docs/assets/1591330/150df3c1-eda5-49ae-8d05-4bfb68254281",alt:""}})]),_._v(" "),v("h5",{attrs:{id:"token-合法性验证"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#token-合法性验证"}},[_._v("#")]),_._v(" token 合法性验证")]),_._v(" "),v("p",[_._v("token 分为两种，一种是由sophon-auth服务生成，另外一种是sophon-messager本身生成，该token只用于本机的命令行命令。\ntoken 会被sophon-messager和sophon-auth依次验证合法性，只要其中一个验证通过就算合法token。\nsophon-auth 验证token合法后会返回该token的权限信息。")]),_._v(" "),v("h5",{attrs:{id:"api权限验证"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#api权限验证"}},[_._v("#")]),_._v(" API权限验证")]),_._v(" "),v("p",[_._v("API权限分为4种："),v("code",[_._v("read")]),_._v(", "),v("code",[_._v("write")]),_._v(", "),v("code",[_._v("sign")]),_._v(", "),v("code",[_._v("admin")]),_._v("，权限依次由低到高，token的权限必须等于或者大于API设定的权限才算验证通过。")]),_._v(" "),v("h4",{attrs:{id:"消息选择"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#消息选择"}},[_._v("#")]),_._v(" 消息选择")]),_._v(" "),v("ul",[v("li",[_._v("获取所有需推送消息的地址，然后并发的按地址选择消息")]),_._v(" "),v("li",[_._v("判断该地址能否推送消息")]),_._v(" "),v("li",[_._v("获取该地的actor，主要是为了获得链上nonce")]),_._v(" "),v("li",[_._v("比较链上nonce和该地址的nonce，若链上nonce大，则更新该地址nonce")]),_._v(" "),v("li",[_._v("获取该地的fill消息并放到待推送列表")]),_._v(" "),v("li",[_._v("与该地址的最大选择消息数比较并计算可推送消息数")]),_._v(" "),v("li",[_._v("获取改地址的unfill消息，并排查已过期消息，最后获得候选消息")]),_._v(" "),v("li",[_._v("通过节点预估候选消息的gas，预估完成后筛除预估失败消息")]),_._v(" "),v("li",[_._v("逐个消息进行签名，直到达到可推送消息，该地址该次选择消息完成")]),_._v(" "),v("li",[_._v("等待各个地址选择消息完成")]),_._v(" "),v("li",[_._v("更新消息信息和地址nonce")]),_._v(" "),v("li",[_._v("推送消息到节点")])]),_._v(" "),v("blockquote",[v("p",[_._v("下图是消息选择流程图")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://github.com/ipfs-force-community/sophon-docs/assets/1591330/aeed760e-6b54-4400-8aa8-7a5878469c7c",alt:""}})]),_._v(" "),v("h4",{attrs:{id:"数据库模块"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#数据库模块"}},[_._v("#")]),_._v(" 数据库模块")]),_._v(" "),v("p",[_._v("该模块设计为能够支持MySQL和SQLite两种数据库，并能够通过配置文件来配置具体使用那个数据库，因此需要将该模块对外交互部分抽象成接口，减少外部对使用不同数据库的感知。\n使用单元测试对该模块各个具体实现进行测试。")]),_._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[_._v("# 统一对外接口\ntype Repo interface {\n    AddressRepo() AddressRepo\n    MessageRepo() MessageRepo\n}\n\n# 地址表接口\ntype AddressRepo interface {}\n# 消息表接口\ntype MessageRepo interface {}\n")])])]),v("h4",{attrs:{id:"消息状态管理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#消息状态管理"}},[_._v("#")]),_._v(" 消息状态管理")]),_._v(" "),v("p",[_._v("消息总共分以下几种状态：")]),_._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[_._v("UnKnown：    unkonwn\nUnFillMsg：  未签名\nFillMsg：    已签名\nOnChainMsg： 已上链\nFailedMsg：  失败\nNonceConflictMsg：被替换\nNoWalletMsg：未找到钱包\n")])])]),v("blockquote",[v("p",[_._v("下图是消息状态转换图")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://github.com/ipfs-force-community/sophon-docs/assets/1591330/883c12f1-fbd0-4d94-b123-6c5fb312dd0a",alt:""}})]),_._v(" "),v("h4",{attrs:{id:"head-处理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#head-处理"}},[_._v("#")]),_._v(" head 处理")]),_._v(" "),v("p",[_._v("通过调用节点ChainNotify接口可以不断的获得新的head，head 里面包含current、apply和revert三种tipset，需要分别对其处理。\n首先对current类型的tipset进行处理，与sophon-messager已处理的tipset做对比，防止漏处理某些tipset。\n然后处理revert tipsets，再处理apply tipsets，根据apply tipset拿到已经上链的消息，然后再逐一更新sophon-messager中对应的消息信息。")]),_._v(" "),v("h4",{attrs:{id:"命令行命令"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#命令行命令"}},[_._v("#")]),_._v(" 命令行命令")]),_._v(" "),v("ul",[v("li",[_._v("全局参数\n"),v("ul",[v("li",[_._v("查询全局参数")]),_._v(" "),v("li",[_._v("设置全局参数")])])]),_._v(" "),v("li",[_._v("地址\n"),v("ul",[v("li",[_._v("查询地址信息")]),_._v(" "),v("li",[_._v("禁止和激活地址")]),_._v(" "),v("li",[_._v("设置选择消息数")])])]),_._v(" "),v("li",[_._v("消息\n"),v("ul",[v("li",[_._v("查询消息信息")]),_._v(" "),v("li",[_._v("列出失败、阻塞消息")]),_._v(" "),v("li",[_._v("更新消息状态")]),_._v(" "),v("li",[_._v("调整消息状态")])])]),_._v(" "),v("li",[_._v("节点\n"),v("ul",[v("li",[_._v("查询节点信息")]),_._v(" "),v("li",[_._v("增加节点")])])])]),_._v(" "),v("h3",{attrs:{id:"数据表设计"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#数据表设计"}},[_._v("#")]),_._v(" 数据表设计")]),_._v(" "),v("p",[_._v("sophon-messager 用到了4张数据表，分别是全局参数表，地址表，消息表，节点信息表，以下是各个表的详细结构。")]),_._v(" "),v("ol",[v("li",[_._v("全局参数表，用于保存全局参数信息")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("name")]),_._v(" "),v("th",[_._v("type")]),_._v(" "),v("th",[_._v("desc")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("id")]),_._v(" "),v("td",[_._v("smallint(2)")]),_._v(" "),v("td",[_._v("primary key")])]),_._v(" "),v("tr",[v("td",[_._v("gas_over_estimation")]),_._v(" "),v("td",[_._v("double")]),_._v(" "),v("td",[_._v("gas limit的系数")])]),_._v(" "),v("tr",[v("td",[_._v("max_fee")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("gas_fee_cap")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("sel_msg_num")]),_._v(" "),v("td",[_._v("bigint(20)")]),_._v(" "),v("td",[_._v("单次选择的最大消息数")])]),_._v(" "),v("tr",[v("td",[_._v("gas_over_premium")]),_._v(" "),v("td",[_._v("DOUBLE")]),_._v(" "),v("td",[_._v("gas premium的系数")])])])]),_._v(" "),v("ol",{attrs:{start:"2"}},[v("li",[_._v("地址表，用于保存地址相关信息")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("name")]),_._v(" "),v("th",[_._v("type")]),_._v(" "),v("th",[_._v("desc")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("id")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("primary key")])]),_._v(" "),v("tr",[v("td",[_._v("addr")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("uniqueIndex, 地址")])]),_._v(" "),v("tr",[v("td",[_._v("nonce")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("地址的nonce")])]),_._v(" "),v("tr",[v("td",[_._v("weight")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("sel_msg_num")]),_._v(" "),v("td",[_._v("bigint(20)")]),_._v(" "),v("td",[_._v("改地址单次选择的最大消息数")])]),_._v(" "),v("tr",[v("td",[_._v("state")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("地址状态")])]),_._v(" "),v("tr",[v("td",[_._v("gas_over_estimation")]),_._v(" "),v("td",[_._v("decimal(10,2)")]),_._v(" "),v("td",[_._v("gas limit的系数")])]),_._v(" "),v("tr",[v("td",[_._v("gas_over_estimation")]),_._v(" "),v("td",[_._v("decimal(10,2)")]),_._v(" "),v("td",[_._v("gas premium的系数")])]),_._v(" "),v("tr",[v("td",[_._v("max_fee")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("gas_fee_cap")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("is_deleted")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("是否删除，-1：否，1：是")])]),_._v(" "),v("tr",[v("td",[_._v("created_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("创建时间")])]),_._v(" "),v("tr",[v("td",[_._v("updated_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("更新时间")])])])]),_._v(" "),v("ol",{attrs:{start:"3"}},[v("li",[_._v("消息表，用于保存消息初始信息，执行结果等信息")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("name")]),_._v(" "),v("th",[_._v("type")]),_._v(" "),v("th",[_._v("desc")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("id")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("primary key")])]),_._v(" "),v("tr",[v("td",[_._v("version")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("消息版本")])]),_._v(" "),v("tr",[v("td",[_._v("nonce")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("消息使用的nonce")])]),_._v(" "),v("tr",[v("td",[_._v("from_addr")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("消息发送地址")])]),_._v(" "),v("tr",[v("td",[_._v("to")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("消息接收地址")])]),_._v(" "),v("tr",[v("td",[_._v("value")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("转账消息表示转账金额")])]),_._v(" "),v("tr",[v("td",[_._v("gas_limit")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("gas_fee_cap")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("gas_premium")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("method")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("执行消息的函数代号")])]),_._v(" "),v("tr",[v("td",[_._v("params")]),_._v(" "),v("td",[_._v("blob")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("signed_data")]),_._v(" "),v("td",[_._v("blob")]),_._v(" "),v("td",[_._v("消息签名结果")])]),_._v(" "),v("tr",[v("td",[_._v("unsigned_cid")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("unsigned消息的CID")])]),_._v(" "),v("tr",[v("td",[_._v("signed_cid")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("signed消息的CID")])]),_._v(" "),v("tr",[v("td",[_._v("height")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("消息打包高度")])]),_._v(" "),v("tr",[v("td",[_._v("receipt_exit_code")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("消息执行完的退出码")])]),_._v(" "),v("tr",[v("td",[_._v("receipt_return_value")]),_._v(" "),v("td",[_._v("blob")]),_._v(" "),v("td",[_._v("消息执行返回值")])]),_._v(" "),v("tr",[v("td",[_._v("receipt_gas_used")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("消息执行消耗的gas")])]),_._v(" "),v("tr",[v("td",[_._v("tipset_key")]),_._v(" "),v("td",[_._v("varchar(1024)")]),_._v(" "),v("td",[_._v("消息打包高度的tipset的key")])]),_._v(" "),v("tr",[v("td",[_._v("meta_expire_epoch")]),_._v(" "),v("td",[_._v("bigint")]),_._v(" "),v("td",[_._v("过期高度")])]),_._v(" "),v("tr",[v("td",[_._v("meta_gas_over_estimation")]),_._v(" "),v("td",[_._v("gas 预估超出的系数")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("meta_max_fee")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("gas 费用上限")])]),_._v(" "),v("tr",[v("td",[_._v("meta_gas_fee_cap")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("gas feecap数值")])]),_._v(" "),v("tr",[v("td",[_._v("meta_gas_over_premium")]),_._v(" "),v("td",[_._v("decimal(10,2)")]),_._v(" "),v("td",[_._v("gas premium的系数")])]),_._v(" "),v("tr",[v("td",[_._v("state")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("消息状态")])]),_._v(" "),v("tr",[v("td",[_._v("is_deleted")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("是否删除，-1：否，1：是")])]),_._v(" "),v("tr",[v("td",[_._v("created_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("创建时间")])]),_._v(" "),v("tr",[v("td",[_._v("updated_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("更新时间")])])])]),_._v(" "),v("ol",{attrs:{start:"4"}},[v("li",[_._v("节点信息表，用于保存节点相关信息")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("name")]),_._v(" "),v("th",[_._v("type")]),_._v(" "),v("th",[_._v("desc")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("id")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("primary key")])]),_._v(" "),v("tr",[v("td",[_._v("name")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("节点名")])]),_._v(" "),v("tr",[v("td",[_._v("url")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("节点 URL")])]),_._v(" "),v("tr",[v("td",[_._v("token")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("节点 token")])]),_._v(" "),v("tr",[v("td",[_._v("node_type")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("节点类型")])]),_._v(" "),v("tr",[v("td",[_._v("is_deleted")]),_._v(" "),v("td",[_._v("int")]),_._v(" "),v("td",[_._v("是否删除，-1：否，1：是")])]),_._v(" "),v("tr",[v("td",[_._v("created_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("创建时间")])]),_._v(" "),v("tr",[v("td",[_._v("updated_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("更新时间")])])])]),_._v(" "),v("ol",{attrs:{start:"5"}},[v("li",[_._v("actor费用配置表")])]),_._v(" "),v("table",[v("thead",[v("tr",[v("th",[_._v("name")]),_._v(" "),v("th",[_._v("type")]),_._v(" "),v("th",[_._v("desc")])])]),_._v(" "),v("tbody",[v("tr",[v("td",[_._v("id")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("primary key")])]),_._v(" "),v("tr",[v("td",[_._v("actor_v")]),_._v(" "),v("td",[_._v("uint")]),_._v(" "),v("td",[_._v("actor版本")])]),_._v(" "),v("tr",[v("td",[_._v("code")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("代码")])]),_._v(" "),v("tr",[v("td",[_._v("method")]),_._v(" "),v("td",[_._v("unsigned bigint")]),_._v(" "),v("td",[_._v("方法号")])]),_._v(" "),v("tr",[v("td",[_._v("gas_over_estimation")]),_._v(" "),v("td",[_._v("decimal(10,2)")]),_._v(" "),v("td",[_._v("gas limit的系数")])]),_._v(" "),v("tr",[v("td",[_._v("gas_over_estimation")]),_._v(" "),v("td",[_._v("decimal(10,2)")]),_._v(" "),v("td",[_._v("gas premium的系数")])]),_._v(" "),v("tr",[v("td",[_._v("max_fee")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("最大费用")])]),_._v(" "),v("tr",[v("td",[_._v("base_fee")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td",[_._v("基础费用阈值")])]),_._v(" "),v("tr",[v("td",[_._v("gas_fee_cap")]),_._v(" "),v("td",[_._v("varchar(256)")]),_._v(" "),v("td")]),_._v(" "),v("tr",[v("td",[_._v("created_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("创建时间")])]),_._v(" "),v("tr",[v("td",[_._v("updated_at")]),_._v(" "),v("td",[_._v("datetime")]),_._v(" "),v("td",[_._v("更新时间")])])])])])}),[],!1,null,null,null);t.default=a.exports}}]);