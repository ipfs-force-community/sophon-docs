(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{432:function(t,v,_){"use strict";_.r(v);var e=_(17),a=Object(e.a)({},(function(){var t=this,v=t.$createElement,_=t._self._c||v;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("h1",{attrs:{id:"venus-messager-design-spec"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#venus-messager-design-spec"}},[t._v("#")]),t._v(" venus-messager design spec")]),t._v(" "),_("p",[t._v("venus-messager is a module/component for managing local messages, storage of messages for different addresses, keeping track of message status, and controling how often messages gets pushed.")]),t._v(" "),_("ul",[_("li",[t._v("multi miner support: provides comprehensive APIs for miners to push their messages")]),t._v(" "),_("li",[t._v("persistent storage: supports MySQL and SQLlite")]),t._v(" "),_("li",[t._v("nonce management: auto nonce assignment to reduce conflicts")]),t._v(" "),_("li",[t._v("dynamic configurations of message pushing frequency and volume")]),t._v(" "),_("li",[t._v("Integration of authentications, tracing and request rate limit")]),t._v(" "),_("li",[t._v("Extensive CLI commands at your disposal")])]),t._v(" "),_("h2",{attrs:{id:"design"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#design"}},[t._v("#")]),t._v(" Design")]),t._v(" "),_("h3",{attrs:{id:"architecture"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#architecture"}},[t._v("#")]),t._v(" Architecture")]),t._v(" "),_("p",[_("img",{attrs:{src:"/venus-messager/venus-messager-design.jpg",alt:""}})]),t._v(" "),_("h3",{attrs:{id:"features"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#features"}},[t._v("#")]),t._v(" Features")]),t._v(" "),_("h4",{attrs:{id:"authentications"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#authentications"}},[t._v("#")]),t._v(" Authentications")]),t._v(" "),_("p",[t._v("Authentication includes two parts, one is to verify whether the token used to access the venus-messager is valid, and the other is to verify whether you have the permission to access the API. The following figure is the authentication flow chart.")]),t._v(" "),_("p",[_("img",{attrs:{src:"/venus-messager/venus-messager-token-verify.jpg",alt:""}})]),t._v(" "),_("h5",{attrs:{id:"validity-of-token"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#validity-of-token"}},[t._v("#")]),t._v(" validity of token")]),t._v(" "),_("p",[t._v("token 分为两种，一种是由venus-auth服务生成，另外一种是venus-messager本身生成，该token只用于本机的命令行命令。\ntoken 会被venus-messager和venus-auth依次验证合法性，只要其中一个验证通过就算合法token。\nvenus-auth 验证token合法后会返回该token的权限信息。")]),t._v(" "),_("h5",{attrs:{id:"api权限验证"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#api权限验证"}},[t._v("#")]),t._v(" API权限验证")]),t._v(" "),_("p",[t._v("API权限分为4种："),_("code",[t._v("read")]),t._v(", "),_("code",[t._v("write")]),t._v(", "),_("code",[t._v("sign")]),t._v(", "),_("code",[t._v("admin")]),t._v("，权限依次由低到高，token的权限必须等于或者大于API设定的权限才算验证通过。")]),t._v(" "),_("h4",{attrs:{id:"消息选择"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#消息选择"}},[t._v("#")]),t._v(" 消息选择")]),t._v(" "),_("ul",[_("li",[t._v("获取所有需推送消息的地址，然后并发的按地址选择消息")]),t._v(" "),_("li",[t._v("判断该地址能否推送消息")]),t._v(" "),_("li",[t._v("获取该地的actor，主要是为了获得链上nonce")]),t._v(" "),_("li",[t._v("比较链上nonce和该地址的nonce，若链上nonce大，则更新该地址nonce")]),t._v(" "),_("li",[t._v("获取该地的fill消息并放到待推送列表")]),t._v(" "),_("li",[t._v("与该地址的最大选择消息数比较并计算可推送消息数")]),t._v(" "),_("li",[t._v("获取改地址的unfill消息，并排查已过期消息，最后获得候选消息")]),t._v(" "),_("li",[t._v("通过节点预估候选消息的gas，预估完成后筛除预估失败消息")]),t._v(" "),_("li",[t._v("逐个消息进行签名，直到达到可推送消息，该地址该次选择消息完成")]),t._v(" "),_("li",[t._v("等待各个地址选择消息完成")]),t._v(" "),_("li",[t._v("更新消息信息和地址nonce")]),t._v(" "),_("li",[t._v("推送消息到节点")])]),t._v(" "),_("blockquote",[_("p",[t._v("下图是消息选择流程图")])]),t._v(" "),_("p",[_("img",{attrs:{src:"/venus-messager/venus-messager-select-message.jpg",alt:""}})]),t._v(" "),_("h4",{attrs:{id:"数据库模块"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#数据库模块"}},[t._v("#")]),t._v(" 数据库模块")]),t._v(" "),_("p",[t._v("该模块设计为能够支持MySQL和SQLlite两种数据库，并能够通过配置文件来配置具体使用那个数据库，因此需要将该模块对外交互部分抽象成接口，减少外部对使用不同数据库的感知。\n使用单元测试对该模块各个具体实现进行测试。")]),t._v(" "),_("div",{staticClass:"language- extra-class"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("# 统一对外接口\ntype Repo interface {\n    AddressRepo() AddressRepo\n    MessageRepo() MessageRepo\n}\n\n# 地址表接口\ntype AddressRepo interface {}\n# 消息表接口\ntype MessageRepo interface {}\n")])])]),_("h4",{attrs:{id:"消息状态管理"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#消息状态管理"}},[t._v("#")]),t._v(" 消息状态管理")]),t._v(" "),_("p",[t._v("消息总共分以下几种状态：")]),t._v(" "),_("div",{staticClass:"language- extra-class"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("UnKnown：    unkonwn\nUnFillMsg：  未签名\nFillMsg：    已签名\nOnChainMsg： 已上链\nFailedMsg：  失败\nReplacedMsg：被替换\nNoWalletMsg：未找到钱包\n")])])]),_("blockquote",[_("p",[t._v("下图是消息状态转换图")])]),t._v(" "),_("p",[_("img",{attrs:{src:"/venus-messager/venus-messager-message-state.jpg",alt:""}})]),t._v(" "),_("h4",{attrs:{id:"head-处理"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#head-处理"}},[t._v("#")]),t._v(" head 处理")]),t._v(" "),_("p",[t._v("通过调用节点ChainNotify接口可以不断的获得新的head，head 里面包含current、apply和revert三种tipset，需要分别对其处理。\n首先对current类型的tipset进行处理，与venus-messager已处理的tipset做对比，防止漏处理某些tipset。\n然后处理revert tipsets，再处理apply tipsets，根据apply tipset拿到已经上链的消息，然后再逐一更新venus-messager中对应的消息信息。")]),t._v(" "),_("h4",{attrs:{id:"命令行命令"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#命令行命令"}},[t._v("#")]),t._v(" 命令行命令")]),t._v(" "),_("ul",[_("li",[t._v("全局参数\n"),_("ul",[_("li",[t._v("查询全局参数")]),t._v(" "),_("li",[t._v("设置全局参数")])])]),t._v(" "),_("li",[t._v("地址\n"),_("ul",[_("li",[t._v("查询地址信息")]),t._v(" "),_("li",[t._v("禁止和激活地址")]),t._v(" "),_("li",[t._v("设置选择消息数")])])]),t._v(" "),_("li",[t._v("消息\n"),_("ul",[_("li",[t._v("查询消息信息")]),t._v(" "),_("li",[t._v("列出失败、阻塞消息")]),t._v(" "),_("li",[t._v("更新消息状态")]),t._v(" "),_("li",[t._v("调整消息状态")])])]),t._v(" "),_("li",[t._v("节点\n"),_("ul",[_("li",[t._v("查询节点信息")]),t._v(" "),_("li",[t._v("增加节点")])])])]),t._v(" "),_("h3",{attrs:{id:"数据表设计"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#数据表设计"}},[t._v("#")]),t._v(" 数据表设计")]),t._v(" "),_("p",[t._v("venus-messager 用到了4张数据表，分别是全局参数表，地址表，消息表，节点信息表，以下是各个表的详细结构。")]),t._v(" "),_("ol",[_("li",[t._v("全局参数表，用于保存全局参数信息")])]),t._v(" "),_("table",[_("thead",[_("tr",[_("th",[t._v("name")]),t._v(" "),_("th",[t._v("type")]),t._v(" "),_("th",[t._v("desc")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("id")]),t._v(" "),_("td",[t._v("smallint(2)")]),t._v(" "),_("td",[t._v("primary key")])]),t._v(" "),_("tr",[_("td",[t._v("gas_over_estimation")]),t._v(" "),_("td",[t._v("double")]),t._v(" "),_("td",[t._v("gas 预估超出的系数")])]),t._v(" "),_("tr",[_("td",[t._v("max_fee")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("max_fee_cap")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("sel_msg_num")]),t._v(" "),_("td",[t._v("bigint(20)")]),t._v(" "),_("td",[t._v("单次选择的最大消息数")])])])]),t._v(" "),_("ol",{attrs:{start:"2"}},[_("li",[t._v("地址表，用于保存地址相关信息")])]),t._v(" "),_("table",[_("thead",[_("tr",[_("th",[t._v("name")]),t._v(" "),_("th",[t._v("type")]),t._v(" "),_("th",[t._v("desc")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("id")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("primary key")])]),t._v(" "),_("tr",[_("td",[t._v("addr")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("uniqueIndex, 地址")])]),t._v(" "),_("tr",[_("td",[t._v("nonce")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("地址的nonce")])]),t._v(" "),_("tr",[_("td",[t._v("weight")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("sel_msg_num")]),t._v(" "),_("td",[t._v("bigint(20)")]),t._v(" "),_("td",[t._v("改地址单次选择的最大消息数")])]),t._v(" "),_("tr",[_("td",[t._v("state")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("地址状态")])]),t._v(" "),_("tr",[_("td",[t._v("gas_over_estimation")]),t._v(" "),_("td",[t._v("decimal(10,2)")]),t._v(" "),_("td",[t._v("gas 预估超出的系数")])]),t._v(" "),_("tr",[_("td",[t._v("max_fee")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("max_fee_cap")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("is_deleted")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("是否删除，-1：否，1：是")])]),t._v(" "),_("tr",[_("td",[t._v("created_at")]),t._v(" "),_("td",[t._v("datetime")]),t._v(" "),_("td",[t._v("创建时间")])]),t._v(" "),_("tr",[_("td",[t._v("updated_at")]),t._v(" "),_("td",[t._v("datetime")]),t._v(" "),_("td",[t._v("更新时间")])])])]),t._v(" "),_("ol",{attrs:{start:"3"}},[_("li",[t._v("消息表，用于保存消息初始信息，执行结果等信息")])]),t._v(" "),_("table",[_("thead",[_("tr",[_("th",[t._v("name")]),t._v(" "),_("th",[t._v("type")]),t._v(" "),_("th",[t._v("desc")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("id")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("primary key")])]),t._v(" "),_("tr",[_("td",[t._v("version")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("消息版本")])]),t._v(" "),_("tr",[_("td",[t._v("nonce")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("消息使用的nonce")])]),t._v(" "),_("tr",[_("td",[t._v("from_addr")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("消息发送地址")])]),t._v(" "),_("tr",[_("td",[t._v("to")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("消息接收地址")])]),t._v(" "),_("tr",[_("td",[t._v("value")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("转账消息表示转账金额")])]),t._v(" "),_("tr",[_("td",[t._v("gas_limit")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("gas_fee_cap")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("gas_premium")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("method")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("执行消息的函数代号")])]),t._v(" "),_("tr",[_("td",[t._v("params")]),t._v(" "),_("td",[t._v("blob")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("signed_data")]),t._v(" "),_("td",[t._v("blob")]),t._v(" "),_("td",[t._v("消息签名结果")])]),t._v(" "),_("tr",[_("td",[t._v("unsigned_cid")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("unsigned消息的CID")])]),t._v(" "),_("tr",[_("td",[t._v("signed_cid")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("signed消息的CID")])]),t._v(" "),_("tr",[_("td",[t._v("height")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("消息打包高度")])]),t._v(" "),_("tr",[_("td",[t._v("receipt_exit_code")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("消息执行完的退出码")])]),t._v(" "),_("tr",[_("td",[t._v("receipt_return_value")]),t._v(" "),_("td",[t._v("blob")]),t._v(" "),_("td",[t._v("消息执行返回值")])]),t._v(" "),_("tr",[_("td",[t._v("receipt_gas_used")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("消息执行消耗的gas")])]),t._v(" "),_("tr",[_("td",[t._v("tipset_key")]),t._v(" "),_("td",[t._v("varchar(1024)")]),t._v(" "),_("td",[t._v("消息打包高度的tipset的key")])]),t._v(" "),_("tr",[_("td",[t._v("meta_expire_epoch")]),t._v(" "),_("td",[t._v("bigint")]),t._v(" "),_("td",[t._v("过期高度")])]),t._v(" "),_("tr",[_("td",[t._v("meta_gas_over_estimation")]),t._v(" "),_("td",[t._v("gas 预估超出的系数")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("meta_max_fee")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("meta_max_fee_cap")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("wallet_name")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("钱包名，用于指定具体签名钱包")])]),t._v(" "),_("tr",[_("td",[t._v("from_user")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("用户名，用于指定具体签名用户")])]),t._v(" "),_("tr",[_("td",[t._v("state")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("消息状态")])]),t._v(" "),_("tr",[_("td",[t._v("is_deleted")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("是否删除，-1：否，1：是")])]),t._v(" "),_("tr",[_("td",[t._v("created_at")]),t._v(" "),_("td",[t._v("datetime")]),t._v(" "),_("td",[t._v("创建时间")])]),t._v(" "),_("tr",[_("td",[t._v("updated_at")]),t._v(" "),_("td",[t._v("datetime")]),t._v(" "),_("td",[t._v("更新时间")])])])]),t._v(" "),_("ol",{attrs:{start:"4"}},[_("li",[t._v("节点信息表，用于保存节点相关信息")])]),t._v(" "),_("table",[_("thead",[_("tr",[_("th",[t._v("name")]),t._v(" "),_("th",[t._v("type")]),t._v(" "),_("th",[t._v("desc")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("id")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("primary key")])]),t._v(" "),_("tr",[_("td",[t._v("name")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("节点名")])]),t._v(" "),_("tr",[_("td",[t._v("url")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("节点 URL")])]),t._v(" "),_("tr",[_("td",[t._v("token")]),t._v(" "),_("td",[t._v("varchar(256)")]),t._v(" "),_("td",[t._v("节点 token")])]),t._v(" "),_("tr",[_("td",[t._v("node_type")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("节点类型")])]),t._v(" "),_("tr",[_("td",[t._v("is_deleted")]),t._v(" "),_("td",[t._v("int")]),t._v(" "),_("td",[t._v("是否删除，-1：否，1：是")])]),t._v(" "),_("tr",[_("td",[t._v("created_at")]),t._v(" "),_("td",[t._v("datetime")]),t._v(" "),_("td",[t._v("创建时间")])]),t._v(" "),_("tr",[_("td",[t._v("updated_at")]),t._v(" "),_("td",[t._v("datetime")]),t._v(" "),_("td",[t._v("更新时间")])])])])])}),[],!1,null,null,null);v.default=a.exports}}]);