(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{464:function(e,a,v){"use strict";v.r(a);var _=v(17),n=Object(_.a)({},(function(){var e=this,a=e.$createElement,v=e._self._c||a;return v("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[v("h1",{attrs:{id:"snapdeal-的支持"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#snapdeal-的支持"}},[e._v("#")]),e._v(" SnapDeal 的支持")]),e._v(" "),v("h2",{attrs:{id:"snapdeal-简述"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#snapdeal-简述"}},[e._v("#")]),e._v(" SnapDeal 简述")]),e._v(" "),v("p",[v("code",[e._v("SnalDeal")]),e._v(" 是在 "),v("a",{attrs:{href:"https://github.com/filecoin-project/FIPs/blob/master/FIPS/fip-0019.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("FIP-19"),v("OutboundLink")],1),e._v(" 中提出，在 "),v("code",[e._v("network15")]),e._v(" 上线的一种扇区升级方案。\n相比之前的升级方案需要重新、完整完成一遍封装过程的巨大开销，"),v("code",[e._v("SnalDeal")]),e._v(" 显得相当轻量，它的开销大约为：")]),e._v(" "),v("ul",[v("li",[e._v("完成一次 "),v("code",[e._v("add piece")])]),e._v(" "),v("li",[e._v("完成一次 "),v("code",[e._v("tree d")])]),e._v(" "),v("li",[e._v("完成一次 "),v("code",[e._v("snap_encode")]),e._v("，其开销约等于一次 "),v("code",[e._v("pc2")])]),e._v(" "),v("li",[e._v("完成一次 "),v("code",[e._v("snap_prove")]),e._v("，其开销约等于一次 "),v("code",[e._v("c1")]),e._v(" + "),v("code",[e._v("c2")]),e._v("\n因此，无论是对于新增的真实数据存储需求，还是对存量 "),v("code",[e._v("CC 扇区")]),e._v(" 进行转化，"),v("code",[e._v("SnalDeal")]),e._v(" 都具备相当的吸引力。")])]),e._v(" "),v("h2",{attrs:{id:"venus-cluster-对-snapdeal-的支持"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#venus-cluster-对-snapdeal-的支持"}},[e._v("#")]),e._v(" venus-cluster 对 SnapDeal 的支持")]),e._v(" "),v("p",[e._v("目前，在 "),v("code",[e._v("lotus")]),e._v(" 和 "),v("code",[e._v("venus")]),e._v(" 现存的算力方案中，对于 "),v("code",[e._v("SnapDeal")]),e._v(" 的支持都局限于手动触发这样一种相对简陋的方式。\n"),v("code",[e._v("venus-cluster")]),e._v(" 在设计之初就着眼于提供生产线模式的算力生产方案，为此我们提供了一种不太需要人工介入的 "),v("code",[e._v("SnapDeal")]),e._v(" 生产方案，我们称之为 "),v("code",[e._v("SnapUp")]),e._v("。它的步骤大致如下：")]),e._v(" "),v("ol",[v("li",[e._v("将已有的 "),v("code",[e._v("CC 扇区")]),e._v(" 批量导入为本地候选扇区")]),e._v(" "),v("li",[e._v("配置 "),v("code",[e._v("venus-sector-manager")]),e._v("，对指定 "),v("code",[e._v("SP")]),e._v(" 启用 "),v("code",[e._v("SnapUp")]),e._v(" 支持")]),e._v(" "),v("li",[e._v("配置 "),v("code",[e._v("venus-worker")]),e._v("，将已有的 "),v("code",[e._v("sealing_thread")]),e._v(" 转化成 "),v("code",[e._v("SnapUp")]),e._v(" 生产计划，或新增用于 "),v("code",[e._v("SnapUp")]),e._v(" 的 "),v("code",[e._v("sealing_thread")]),e._v("\n整个过程中，使用者仅需关注本地候选扇区的导入和余量，其余过程都会自动完成。")])]),e._v(" "),v("h2",{attrs:{id:"示例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[e._v("#")]),e._v(" 示例")]),e._v(" "),v("p",[e._v("下面以一套 "),v("code",[e._v("butterfly")]),e._v(" 网络上的生产集群为例，逐步演示如何配置 "),v("code",[e._v("SnapUp")]),e._v(" 的生产方案。")]),e._v(" "),v("h3",{attrs:{id:"候选扇区的导入"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#候选扇区的导入"}},[e._v("#")]),e._v(" 候选扇区的导入")]),e._v(" "),v("p",[e._v("使用新增的 "),v("code",[e._v("util sealer snap fetch")]),e._v(" 工具，能够按 "),v("code",[e._v("deadline")]),e._v(" 将满足限制（剩余生命周期大于180天，满足订单的最小生命周期）的 "),v("code",[e._v("CC 扇区")]),e._v(" 导入为本地候选扇区。")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v('./dist/bin/venus-sector-manager --net butterfly util sealer snap fetch 1153 3\n2022-04-15T04:28:03.380Z        DEBUG   policy  policy/const.go:18      NETWORK SETUP   {"name": "butterfly"}\n2022-04-15T04:28:03.401Z        INFO    cmd     internal/util_sealer_snap.go:53 cadidate sectors fetched        {"available-in-deadline": 2, "added": 2}\n')])])]),v("h3",{attrs:{id:"观察候选扇区的余量"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#观察候选扇区的余量"}},[e._v("#")]),e._v(" 观察候选扇区的余量")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v('./dist/bin/venus-sector-manager --net butterfly util sealer snap candidates 1153\n2022-04-15T04:28:13.955Z        DEBUG   policy  policy/const.go:18      NETWORK SETUP   {"name": "butterfly"}\ndeadline  count\n3         2\n')])])]),v("p",[e._v("可以看到，当前存在 2 个 "),v("code",[e._v("#3 deadline")]),e._v(" 中的 "),v("code",[e._v("CC 扇区")]),e._v(" 作为候选，可供升级")]),e._v(" "),v("h3",{attrs:{id:"配置-venus-worker"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#配置-venus-worker"}},[e._v("#")]),e._v(" 配置 "),v("code",[e._v("venus-worker")])]),e._v(" "),v("p",[v("code",[e._v("venus-worker")]),e._v(" 中需要配置的内容主要是用于 "),v("code",[e._v("SnapUp")]),e._v(" 任务的 "),v("code",[e._v("sealing_thread")]),e._v("， 和针对 "),v("code",[e._v("snap_encode")]),e._v("、"),v("code",[e._v("snap_prove")]),e._v(" 的计算资源分配。")]),e._v(" "),v("p",[e._v("示例如下：")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v('[[sealing_thread]]\nlocation = "/data/local-snap"\nplan = "snapup"\n\n[processors.limitation.concurrent]\n...\ntree_d = 1\nsnap_encode = 1\nsnap_prove = 1\n\n[[processors.snap_encode]]\ncgroup.cpuset = "48-63"\nenvs = { FIL_PROOFS_USE_GPU_COLUMN_BUILDER = "1", FIL_PROOFS_USE_GPU_TREE_BUILDER = "1", CUDA_VISIBLE_DEVICES = "0" }\n\n[[processors.snap_prove]]\ncgroup.cpuset = "16-31"\nenvs = { CUDA_VISIBLE_DEVICES = "1" }\n')])])]),v("p",[v("code",[e._v("snap_encode")]),e._v(" 的计算资源分配可以参考 "),v("code",[e._v("pc2")]),e._v("，"),v("code",[e._v("snap_prove")]),e._v(" 的计算资源分配可以参考 "),v("code",[e._v("c2")])]),e._v(" "),v("h3",{attrs:{id:"配置-venus-sector-manager"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#配置-venus-sector-manager"}},[e._v("#")]),e._v(" 配置 "),v("code",[e._v("venus-sector-manager")])]),e._v(" "),v("p",[v("code",[e._v("venus-sector-manager")]),e._v(" 中需要的配置内容主要是为指定的 "),v("code",[e._v("SP")]),e._v(" 启用 "),v("code",[e._v("SnapUp")]),e._v("，示例如下：")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v('[[Miners]]\nActor = 1153\n[Miners.Sector]\nInitNumber = 0\nMaxNumber = 10000\nEnabled = true\nEnableDeals = false\n\n[Miners.SnapUp]\nEnabled = true\nSender = "t1abjxfbp274xpdqcpuaykwkfb43omjotacm2p3za"\n')])])]),v("p",[e._v("其中")]),e._v(" "),v("ul",[v("li",[v("code",[e._v("[Miners.Sector]")]),e._v(" 块中的配置内容不会影响 "),v("code",[e._v("SnapUp")]),e._v(" 的运转。")]),e._v(" "),v("li",[e._v("在这套配置下，将可以支持：\n"),v("ul",[v("li",[v("code",[e._v("CC 扇区")]),e._v(" 持续生产")]),e._v(" "),v("li",[v("code",[e._v("SnapUp")]),e._v(" 在本地候选扇区有余量的情况下持续生产")])])])]),e._v(" "),v("h3",{attrs:{id:"注意事项"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[e._v("#")]),e._v(" 注意事项：")]),e._v(" "),v("ol",[v("li",[e._v("考虑到 "),v("code",[e._v("snap_encode")]),e._v(" 和 "),v("code",[e._v("snap_prove")]),e._v(" 所需的计算资源，如果在同一个 "),v("code",[e._v("venus-worker")]),e._v(" 实例中同时启用常规扇区封装和 "),v("code",[e._v("SnapUp")]),e._v(" 的话，可能需要考虑资源竞争的情况，可以参考 "),v("a",{attrs:{href:"https://github.com/ipfs-force-community/venus-cluster/blob/main/docs/zh/07.venus-worker%E5%A4%96%E9%83%A8%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("07.venus-worker外部执行器的配置范例"),v("OutboundLink")],1)]),e._v(" "),v("li",[e._v("考虑到扇区持久化数据的分布情况，用于 "),v("code",[e._v("SnapUp")]),e._v(" 的 "),v("code",[e._v("venus-worker")]),e._v(" 需要同时能够以可读可写的方式访问所有持久化存储空间("),v("code",[e._v("persist store")]),e._v(")，且确保他们的命名和 "),v("code",[e._v("venus-sector-manager")]),e._v(" 中一致。")]),e._v(" "),v("li",[e._v("基于以上两点，我们推荐使用单独的设备专门进行 "),v("code",[e._v("SnapUp")]),e._v(" 的生产，从而避免常规扇区和 "),v("code",[e._v("SnapUp")]),e._v(" 混布带来的配置和运维的复杂度。")])]),e._v(" "),v("h2",{attrs:{id:"持续优化"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#持续优化"}},[e._v("#")]),e._v(" 持续优化")]),e._v(" "),v("p",[e._v("对于 "),v("code",[e._v("SnapUp")]),e._v(" 方案的完善和优化还在不断进行中，目前我们主要关注：")]),e._v(" "),v("ul",[v("li",[e._v("将半自动的候选扇区导入转换成自动方式，或提供等效的运维工具")]),e._v(" "),v("li",[e._v("更多候选扇区导入规则，如按存储配置导入")]),e._v(" "),v("li",[e._v("上链消息的聚合，以降低成本")]),e._v(" "),v("li",[e._v("其他能够简化运维、降低成本、提高效率的优化和工具")])])])}),[],!1,null,null,null);a.default=n.exports}}]);