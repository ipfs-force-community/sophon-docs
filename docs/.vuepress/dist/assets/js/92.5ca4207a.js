(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{466:function(_,c,v){"use strict";v.r(c);var e=v(17),r=Object(e.a)({},(function(){var _=this,c=_.$createElement,v=_._self._c||c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"venus-worker外部执行器的配置范例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#venus-worker外部执行器的配置范例"}},[_._v("#")]),_._v(" venus-worker外部执行器的配置范例")]),_._v(" "),v("p",[_._v("在其他文档中，我们介绍了 "),v("code",[_._v("processor")]),_._v(" 的基本概念，也分析了 "),v("code",[_._v("venus-worker")]),_._v(" 中关于 "),v("code",[_._v("processor")]),_._v(" 的配置项。\n接下来，我们以一个实际场景为例，来看看具体如何编排外部处理器。")]),_._v(" "),v("h2",{attrs:{id:"实例分析"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#实例分析"}},[_._v("#")]),_._v(" 实例分析")]),_._v(" "),v("h3",{attrs:{id:"硬件配置"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#硬件配置"}},[_._v("#")]),_._v(" 硬件配置")]),_._v(" "),v("p",[_._v("我们针对的配置为：")]),_._v(" "),v("ul",[v("li",[_._v("双路 "),v("code",[_._v("AMD EPYC 7642 48-Core Processor")])]),_._v(" "),v("li",[_._v("2T 内存")]),_._v(" "),v("li",[v("code",[_._v("GeForce RTX 3080")]),_._v(" x 2")]),_._v(" "),v("li",[_._v("足量的本地 NVME 数据盘")])]),_._v(" "),v("p",[_._v("这样，我们可使用的计算资源约为：")]),_._v(" "),v("ul",[v("li",[_._v("96个CPU物理核，以 3c/DIE 计，共 32 个可用的 pc1 multicore 组")]),_._v(" "),v("li",[_._v("约 1.96TiB 可用物理内存")]),_._v(" "),v("li",[_._v("2块 "),v("code",[_._v("GeForce RTX 3080")]),_._v(" GPU")])]),_._v(" "),v("h3",{attrs:{id:"配比方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#配比方案"}},[_._v("#")]),_._v(" 配比方案")]),_._v(" "),v("p",[_._v("考虑 32GiB CC 扇区的封装，我们存在两种可能的配比方案，以下分别阐述。\n"),v("strong",[_._v("注意")]),_._v("：以下的设计可以作为方案参考，但不宜直接用于生产环境。\n使用者需要根据实际情况，以及试验阶段的产量情况进行调整。")]),_._v(" "),v("h4",{attrs:{id:"方案-a-28-pc1-1-pc2-1-c2-pc2-与-c2-各组独占gpu"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#方案-a-28-pc1-1-pc2-1-c2-pc2-与-c2-各组独占gpu"}},[_._v("#")]),_._v(" 方案 A: 28 pc1，1 pc2, 1 c2，pc2 与 c2 各组独占GPU")]),_._v(" "),v("p",[_._v("这种方案的思路，是在满足消费能力的前提下，共用各一个的独立 pc2、c2 外部执行器。\n其 "),v("code",[_._v("processors")]),_._v(" 部分的配置如下：")]),_._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[_._v('[processors.limitation.concurrent]\npc1 = 28\npc2 = 1\nc2 = 1\n\n[[processors.pc1]]\nnuma_preferred = 0\ncgroup.cpuset = "0-41"\nconcurrent = 14\nenvs = { FIL_PROOFS_MAXIMIZE_CACHING="1", FIL_PROOFS_USE_MULTICORE_SDR = "1", FIL_PROOFS_MULTICORE_SDR_PRODUCERS = "1" }\n\n[[processors.pc1]]\nnuma_preferred = 1\ncgroup.cpuset = "48-89"\nconcurrent = 14\nenvs = { FIL_PROOFS_MAXIMIZE_CACHING="1", FIL_PROOFS_USE_MULTICORE_SDR = "1", FIL_PROOFS_MULTICORE_SDR_PRODUCERS = "1" }\n\n[[processors.pc2]]\ncgroup.cpuset =  "2,5,8,11,50,53,56,59"\nenvs = { FIL_PROOFS_USE_GPU_COLUMN_BUILDER = "1", FIL_PROOFS_USE_GPU_TREE_BUILDER = "1", CUDA_VISIBLE_DEVICES = "0" }\n\n[[processors.c2]]\ncgroup.cpuset =  "14,17,20,23,26,29,32,35,42-47,62,65,68,71,74,77,80,83,90-95"\nenvs = { CUDA_VISIBLE_DEVICES = "1" }\n')])])]),v("p",[_._v("在此配置下，共启动 2 个外部 "),v("code",[_._v("pc1")]),_._v(" 执行器，1 个外部 "),v("code",[_._v("pc2")]),_._v(" 执行器，1 个外部 "),v("code",[_._v("c2")]),_._v(" 执行器：")]),_._v(" "),v("ul",[v("li",[_._v("1 个 "),v("code",[_._v("pc1")]),_._v(" 外部处理器，指定内存亲和 numa 0 区，使用 1 个主核 + 1 个 Producer 核的配置，分配位于 numa 0 区的 CPU核 "),v("code",[_._v("0-41")]),_._v("；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("pc1")]),_._v(" 外部处理器，指定内存亲和 numa 1 区，使用 1 个主核 + 1 个 Producer 核的配置，分配位于 numa 1 区的 CPU核 "),v("code",[_._v("48-89")]),_._v("；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("pc2")]),_._v(" 外部处理器，使用 CPU 核 "),v("code",[_._v("2,5,8,11,50,53,56,59")]),_._v("，指定可见序号为 0 的 GPU；\n这种方法可行的原因是在当前的 "),v("code",[_._v("pc1")]),_._v(" 配置下，每个 DIE 会空出一个核，可以用来执行轻量的计算任务。而 "),v("code",[_._v("pc2")]),_._v(" 在使用 GPU 的情况下，CPU 基本只用于数据搬运；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("c2")]),_._v(" 外部处理器，使用 CPU 核 "),v("code",[_._v("14,17,20,23,26,29,32,35,42-47,62,65,68,71,74,77,80,83,90-95")]),_._v("，指定可见序号为 1 的 GPU；")]),_._v(" "),v("li",[_._v("空余 CPU 核 "),v("code",[_._v("38,41,86,89")]),_._v("，可以用于其他轻量任务，如运维管理等。")])]),_._v(" "),v("p",[_._v("这种方案的优势是，"),v("code",[_._v("pc2")]),_._v(" 和 "),v("code",[_._v("c2")]),_._v(" 都各自独占资源，不会出现调度上的问题。")]),_._v(" "),v("h4",{attrs:{id:"方案-b-28-pc1-2-pc2-2-c2-每个-pc2-与-一个-c2-形成一组-每组占用-1-gpu-组内不同阶段的任务形成竞争关系"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#方案-b-28-pc1-2-pc2-2-c2-每个-pc2-与-一个-c2-形成一组-每组占用-1-gpu-组内不同阶段的任务形成竞争关系"}},[_._v("#")]),_._v(" 方案 B: 28 pc1，2 pc2, 2 c2，每个 pc2 与 一个 c2 形成一组，每组占用 1 GPU，组内不同阶段的任务形成竞争关系")]),_._v(" "),v("p",[_._v("这种方案的思路，实际上是将双路的硬件配置视作2组单路硬件的组合，对于每一个单路组执行一样的配置策略。\n其 "),v("code",[_._v("processors")]),_._v(" 部分的配置如下：")]),_._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[_._v('\n[processors.limitation.concurrent]\npc1 = 28\npc2 = 2\nc2 = 2\n\n[processors.ext_locks]\ngpu1 = 1\ngpu2 = 1\n\n[[processors.pc1]]\nnuma_preferred = 0\ncgroup.cpuset = "0-41"\nconcurrent = 14\nenvs = { FIL_PROOFS_MAXIMIZE_CACHING="1", FIL_PROOFS_USE_MULTICORE_SDR = "1", FIL_PROOFS_MULTICORE_SDR_PRODUCERS = "1" }\n\n[[processors.pc1]]\nnuma_preferred = 1\ncgroup.cpuset = "48-89"\nconcurrent = 14\nenvs = { FIL_PROOFS_MAXIMIZE_CACHING="1", FIL_PROOFS_USE_MULTICORE_SDR = "1", FIL_PROOFS_MULTICORE_SDR_PRODUCERS = "1" }\n\n[[processors.pc2]]\ncgroup.cpuset =  "2,5,8,11,14,17,20,23"\nlocks = ["gpu1"]\nenvs = { FIL_PROOFS_USE_GPU_COLUMN_BUILDER = "1", FIL_PROOFS_USE_GPU_TREE_BUILDER = "1", CUDA_VISIBLE_DEVICES = "0" }\n\n[[processors.pc2]]\ncgroup.cpuset =  "50,53,56,59,62,65,68,71"\nlocks = ["gpu2"]\nenvs = { FIL_PROOFS_USE_GPU_COLUMN_BUILDER = "1", FIL_PROOFS_USE_GPU_TREE_BUILDER = "1", CUDA_VISIBLE_DEVICES = "1" }\n\n[[processors.c2]]\ncgroup.cpuset =  "2,5,8,11,14,17,20,23,26,29,32,35,42-47"\nlocks = ["gpu1"]\nenvs = { CUDA_VISIBLE_DEVICES = "0" }\n\n[[processors.c2]]\ncgroup.cpuset =  "50,53,56,59,62,65,68,71,74,77,80,83,90-95"\nlocks = ["gpu2"]\nenvs = { CUDA_VISIBLE_DEVICES = "1" }\n')])])]),v("p",[_._v("在此配置下，共启动 2 个外部 pc1 执行器，2 个外部 pc2 执行器，2 个外部 c2 执行器：")]),_._v(" "),v("ul",[v("li",[_._v("1 个 "),v("code",[_._v("pc1")]),_._v(" 外部处理器，指定内存亲和 numa 0 区，使用 1 个主核 + 1 个 Producer 核的配置，分配位于 numa 0 区的 CPU核 "),v("code",[_._v("0-41")]),_._v("；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("pc1")]),_._v(" 外部处理器，指定内存亲和 numa 1 区，使用 1 个主核 + 1 个 Producer 核的配置，分配位于 numa 1 区的 CPU核 "),v("code",[_._v("48-89")]),_._v("；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("pc2")]),_._v(" 与 1 个 "),v("code",[_._v("c2")]),_._v(" 围绕自定义控制锁 "),v("code",[_._v("gpu1")]),_._v(" 形成竞争关系，继而形成一个组，其中：\n"),v("ul",[v("li",[_._v("1 个 "),v("code",[_._v("pc2")]),_._v("，使用 CPU 核 "),v("code",[_._v("2,5,8,11,14,17,20,23")]),_._v(", 指定可见序号为 0 的 GPU；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("c2")]),_._v("， 使用 CPU 核 "),v("code",[_._v("2,5,8,11,14,17,20,23,26,29,32,35,42-47")]),_._v("，指定可见序号为 0 的 GPU；\n可以这样做的原因是，受限于自定义控制锁，本组内的 "),v("code",[_._v("pc2")]),_._v(" 和 "),v("code",[_._v("c2")]),_._v(" 处理器不会同时执行任务，因而可以共用部分 CPU 和 GPU 资源；")])])]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("pc2")]),_._v(" 与 1 个 "),v("code",[_._v("c2")]),_._v(" 围绕自定义控制锁 "),v("code",[_._v("gpu2")]),_._v(" 形成竞争关系，继而形成一个组，其中：\n"),v("ul",[v("li",[_._v("1 个 "),v("code",[_._v("pc2")]),_._v("，使用 CPU 核 "),v("code",[_._v("50,53,56,59,62,65,68,71")]),_._v(", 指定可见序号为 1 的 GPU；")]),_._v(" "),v("li",[_._v("1 个 "),v("code",[_._v("c2")]),_._v("， 使用 CPU 核 "),v("code",[_._v("50,53,56,59,62,65,68,71,74,77,80,83,90-95")]),_._v("，指定可见序号为 1 的 GPU；")])])]),_._v(" "),v("li",[_._v("空余 CPU 核 "),v("code",[_._v("38,41,86,89")]),_._v("，可以用于其他轻量任务，如运维管理等。")])]),_._v(" "),v("p",[_._v("相比方案 A，本方案可能存在一种极端情况：即控制锁始终被一种任务持续持有，而导致另一种任务长时间无法执行任务，导致扇区消费不通畅。\n用通俗的话来说，可以类比为：GPU 长时间被用于执行 "),v("code",[_._v("pc2")]),_._v("，无法释放给 "),v("code",[_._v("c2")]),_._v("， 导致等待 "),v("code",[_._v("c2")]),_._v(" 资源的扇区堆积。")]),_._v(" "),v("h2",{attrs:{id:"总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[_._v("#")]),_._v(" 总结")]),_._v(" "),v("p",[_._v("本文档提供的，是 "),v("em",[_._v("如何设计一个适合自身的配比方案")]),_._v("，而非 "),v("em",[_._v("一套适用一切场景的配比方案")]),_._v("。\n后续我们希望能提供更多的自动配置工具、计算器来简化使用者设计方案的过程，但同时，仍然建议使用者对方案中的关键环节有基本的理解。")])])}),[],!1,null,null,null);c.default=r.exports}}]);