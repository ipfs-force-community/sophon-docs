<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deployment highly available daemon | Sophon</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/assets/sophon-icon.png">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-RHJWEBDXVD"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RHJWEBDXVD');</script>
    <meta name="description" content="Sophon, formerly known as Venus Chain Service, is THE Filecoin super node solution.">
    
    <link rel="preload" href="/assets/css/0.styles.117964e0.css" as="style"><link rel="preload" href="/assets/js/app.c78dcdb4.js" as="script"><link rel="preload" href="/assets/js/2.20e7910a.js" as="script"><link rel="preload" href="/assets/js/27.ad555126.js" as="script"><link rel="prefetch" href="/assets/js/10.f067a250.js"><link rel="prefetch" href="/assets/js/11.2a60a7f2.js"><link rel="prefetch" href="/assets/js/12.0d1843dc.js"><link rel="prefetch" href="/assets/js/13.647f3f5f.js"><link rel="prefetch" href="/assets/js/14.476c8200.js"><link rel="prefetch" href="/assets/js/15.0770bc0e.js"><link rel="prefetch" href="/assets/js/16.8f2df686.js"><link rel="prefetch" href="/assets/js/17.f13feb39.js"><link rel="prefetch" href="/assets/js/18.01482bd2.js"><link rel="prefetch" href="/assets/js/19.3e4e1d23.js"><link rel="prefetch" href="/assets/js/20.9ce550c8.js"><link rel="prefetch" href="/assets/js/21.7dec4985.js"><link rel="prefetch" href="/assets/js/22.2b7829c7.js"><link rel="prefetch" href="/assets/js/23.509ca501.js"><link rel="prefetch" href="/assets/js/24.b4a42c92.js"><link rel="prefetch" href="/assets/js/25.d96952a2.js"><link rel="prefetch" href="/assets/js/26.dc528c39.js"><link rel="prefetch" href="/assets/js/28.7f1ab36e.js"><link rel="prefetch" href="/assets/js/29.bfbaf1f1.js"><link rel="prefetch" href="/assets/js/3.badb68ea.js"><link rel="prefetch" href="/assets/js/30.6f6fb490.js"><link rel="prefetch" href="/assets/js/31.57f2ce80.js"><link rel="prefetch" href="/assets/js/32.9f9a4eee.js"><link rel="prefetch" href="/assets/js/33.315f97ca.js"><link rel="prefetch" href="/assets/js/34.5236c653.js"><link rel="prefetch" href="/assets/js/35.20e22266.js"><link rel="prefetch" href="/assets/js/36.e10c8196.js"><link rel="prefetch" href="/assets/js/37.97bfbb2e.js"><link rel="prefetch" href="/assets/js/38.27982756.js"><link rel="prefetch" href="/assets/js/39.ca4037bd.js"><link rel="prefetch" href="/assets/js/4.06777882.js"><link rel="prefetch" href="/assets/js/40.3ce1d405.js"><link rel="prefetch" href="/assets/js/41.6df97013.js"><link rel="prefetch" href="/assets/js/42.3cae37fd.js"><link rel="prefetch" href="/assets/js/43.720a1d98.js"><link rel="prefetch" href="/assets/js/44.0b1a4d92.js"><link rel="prefetch" href="/assets/js/45.1a34b47b.js"><link rel="prefetch" href="/assets/js/46.2d68c635.js"><link rel="prefetch" href="/assets/js/47.008b2138.js"><link rel="prefetch" href="/assets/js/48.2edc44b6.js"><link rel="prefetch" href="/assets/js/49.263dd958.js"><link rel="prefetch" href="/assets/js/5.d51f6b5b.js"><link rel="prefetch" href="/assets/js/50.d3d4b631.js"><link rel="prefetch" href="/assets/js/51.073e0046.js"><link rel="prefetch" href="/assets/js/52.cf494c22.js"><link rel="prefetch" href="/assets/js/53.58095bec.js"><link rel="prefetch" href="/assets/js/54.f3808261.js"><link rel="prefetch" href="/assets/js/55.98f35d10.js"><link rel="prefetch" href="/assets/js/56.d7f0da33.js"><link rel="prefetch" href="/assets/js/57.d0a38443.js"><link rel="prefetch" href="/assets/js/58.03a0a0b6.js"><link rel="prefetch" href="/assets/js/59.f3368deb.js"><link rel="prefetch" href="/assets/js/6.0f01c240.js"><link rel="prefetch" href="/assets/js/60.2f444e47.js"><link rel="prefetch" href="/assets/js/61.fee56bbb.js"><link rel="prefetch" href="/assets/js/62.19ee616e.js"><link rel="prefetch" href="/assets/js/63.a29fffde.js"><link rel="prefetch" href="/assets/js/64.0704e793.js"><link rel="prefetch" href="/assets/js/65.e1f8dbe8.js"><link rel="prefetch" href="/assets/js/66.13358587.js"><link rel="prefetch" href="/assets/js/67.57a66036.js"><link rel="prefetch" href="/assets/js/68.782f6559.js"><link rel="prefetch" href="/assets/js/69.11f51a61.js"><link rel="prefetch" href="/assets/js/7.6468bc2e.js"><link rel="prefetch" href="/assets/js/8.a56e2715.js"><link rel="prefetch" href="/assets/js/9.5ad987d3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.117964e0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/sophon-icon.png" alt="Sophon" class="logo"> <span class="site-name can-hide">Sophon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/intro/" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/operation/" class="nav-link router-link-active">
  Deployment &amp; Operation
</a></div><div class="nav-item"><a href="/developer/" class="nav-link">
  Developer
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/operation/ha.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/ha.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/intro/" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/operation/" class="nav-link router-link-active">
  Deployment &amp; Operation
</a></div><div class="nav-item"><a href="/developer/" class="nav-link">
  Developer
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/operation/ha.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/ha.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Deployment</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/operation/" aria-current="page" class="sidebar-link">Before deployment</a></li><li><a href="/operation/deploy-a-cs.html" class="sidebar-link">Deploy a Sophon service</a></li><li><a href="/operation/join-a-cs.html" class="sidebar-link">Use a Sophon service</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Sophon Components</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/operation/venus-daemon.html" class="sidebar-link">venus daemon</a></li><li><a href="/operation/venus-auth.html" class="sidebar-link">venus-auth</a></li><li><a href="/operation/venus-miner.html" class="sidebar-link">venus-miner</a></li><li><a href="/operation/venus-messager.html" class="sidebar-link">venus-messager</a></li><li><a href="/operation/venus-gateway.html" class="sidebar-link">venus-gateway</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Optional Components</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/operation/venus-wallet-builtin.html" class="sidebar-link">venus-wallet (builtin)</a></li><li><a href="/operation/venus-wallet.html" class="sidebar-link">venus-wallet (remote)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Operations</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/operation/chain-mng.html" class="sidebar-link">Chain management</a></li><li><a href="/operation/simple-load-balancing.html" class="sidebar-link">Simple load balancing</a></li><li><a href="/operation/ha.html" aria-current="page" class="active sidebar-link">High availability solution</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/operation/ha.html#daemon" class="sidebar-link">daemon</a></li><li class="sidebar-sub-header"><a href="/operation/ha.html#chain-co-agent" class="sidebar-link">chain-co agent</a></li><li class="sidebar-sub-header"><a href="/operation/ha.html#proxy-optional" class="sidebar-link">proxy(optional)</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deployment-highly-available-daemon"><a href="#deployment-highly-available-daemon" class="header-anchor">#</a> Deployment highly available daemon</h1> <p>The main purpose of this solution is to prevent the overall failure of service due to a single node failure. Since the node program may be able to be running, but there is a situation of out of synchronization(daemon still running), it is impossible to automatically select a good node using the nginx service simply. In this solution, a new proxy program is used between nginx and the node program to solve the problem. The proxy program will automatically monitor the height and weight changes in multiple nodes, and only the best node will be selected for each request. Another security feature is that nodes can choose different implementations, so that if something goes wrong with one implementation, nodes with other implementations can also work.</p> <p><img src="https://raw.githubusercontent.com/hunjixin/imgpool/master/chain-co.png" alt=""></p> <h2 id="daemon"><a href="#daemon" class="header-anchor">#</a> daemon</h2> <p>api auth suggest to use venus-auth but not local.  in local mode, when reimport snapshot, token will change.</p> <p>venus:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#build</span>
<span class="token function">git</span> clone https://github.com/filecoin-project/venus.git
<span class="token function">git</span> checkout <span class="token operator">&lt;</span>RELEASE TAG<span class="token operator">&gt;</span>
<span class="token function">make</span>
<span class="token comment">#run</span>
./venus daemon --network <span class="token operator">&lt;</span>network-type<span class="token operator">&gt;</span> --auth-url <span class="token operator">&lt;</span>venus-auth url<span class="token operator">&gt;</span> --auth-token <span class="token operator">&lt;</span>venus-auth token<span class="token operator">&gt;</span>
</code></pre></div><p>lotus:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#build</span>
<span class="token function">git</span> clone https://github.com/ipfs-force-community/lotus.git
<span class="token function">git</span> checkout <span class="token operator">&lt;</span>RELEASE TAG<span class="token operator">&gt;</span>
<span class="token function">make</span> <span class="token operator">&lt;</span>network-type<span class="token operator">&gt;</span>
<span class="token comment">#run</span>
./lotus daemon --auth-url <span class="token operator">&lt;</span>venus-auth url<span class="token operator">&gt;</span> --auth-token <span class="token operator">&lt;</span>venus-auth token<span class="token operator">&gt;</span>
</code></pre></div><h2 id="chain-co-agent"><a href="#chain-co-agent" class="header-anchor">#</a> chain-co agent</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#build</span>
<span class="token function">git</span> clone https://github.com/ipfs-force-community/chain-co.git
<span class="token function">git</span> checkout <span class="token operator">&lt;</span>RELEASE TAG<span class="token operator">&gt;</span>
<span class="token function">make</span>
<span class="token comment">#run</span>
./chain-co  run -listen <span class="token number">0.0</span>.0.0:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> --auth <span class="token operator">&lt;</span>venus-auth-token:venus-auth-url<span class="token operator">&gt;</span> --node <span class="token operator">&lt;</span>token:rpc-url<span class="token operator">&gt;</span> --node<span class="token operator">&lt;</span>token:rpc-url<span class="token operator">&gt;</span>
</code></pre></div><h2 id="proxy-optional"><a href="#proxy-optional" class="header-anchor">#</a> proxy(optional)</h2> <p>There are many options for the proxy, including load balancing such as nginx, slb, etc., but note that it needs to support websocket and custom http headers. Take nginx as an example here
install nginx: https://www.nginx.com/resources/wiki/start/topics/tutorials/install</p> <p>nginx config:</p> <div class="language- extra-class"><pre class="language-text"><code>user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

worker_rlimit_nofile 655350;
# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 655350;
}

http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
 
    upstream websocket {
        server &lt;endpoint&gt;;
    }
 
    server {
        listen 34530;
      #  listen 34531 ssl; #https

      #  server_name &lt;server name&gt;;       

      #  access_log  /root/proxy.access.log;
      #  error_log   /root/proxy.error.log;

      #  ssl_certificate  &lt;ssl&gt;;
      #  ssl_certificate_key &lt;key&gt;;
         ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

        location / {
            proxy_pass http://websocket;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Authorization $http_authorization;    #import
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        }
   }
}
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ul><li>Because the data between nodes is still separated, it is impossible to provide completely consistent api, especially in the processing of the top header block. Therefore, when writing a program, it is necessary to take into condisider the possible inconsistencies of different nodes.</li> <li>If you deploy lotus, you need to use a customized version, because venus has some unique api.</li> <li>If there is a problem, please make an issue on venus.</li></ul></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ipfs-force-community/sophon-docs/edit/main/docs/operation/ha.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/17/2023, 10:15:32 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/operation/simple-load-balancing.html" class="prev">
        Simple load balancing
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c78dcdb4.js" defer></script><script src="/assets/js/2.20e7910a.js" defer></script><script src="/assets/js/27.ad555126.js" defer></script>
  </body>
</html>
